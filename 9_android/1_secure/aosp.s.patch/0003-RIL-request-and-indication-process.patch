From 6c0921e0a3461d8f16fb1d1f020d8f2217c4621f Mon Sep 17 00:00:00 2001
From: tanshuai <tanshuai@xdja.com>
Date: Sun, 21 Aug 2022 17:08:09 +0800
Subject: [PATCH 03/11] RIL request and indication process

---
 .../internal/telephony/RILRequest.java        | 19 ++++++++++++--
 .../internal/telephony/RadioIndication.java   | 26 +++++++++++++++++++
 2 files changed, 43 insertions(+), 2 deletions(-)

diff --git a/frameworks/opt/telephony/src/java/com/android/internal/telephony/RILRequest.java b/frameworks/opt/telephony/src/java/com/android/internal/telephony/RILRequest.java
index fff8de690a..e261f87e57 100644
--- a/frameworks/opt/telephony/src/java/com/android/internal/telephony/RILRequest.java
+++ b/frameworks/opt/telephony/src/java/com/android/internal/telephony/RILRequest.java
@@ -22,6 +22,7 @@ import android.os.Message;
 import android.os.SystemClock;
 import android.os.WorkSource;
 import android.os.WorkSource.WorkChain;
+import android.os.SystemProperties;
 
 import com.android.telephony.Rlog;
 
@@ -43,6 +44,9 @@ public class RILRequest {
     private static RILRequest sPool = null;
     private static int sPoolSize = 0;
     private static final int MAX_POOL_SIZE = 4;
+    private static final int MAX_SERIAL_NUM = Integer.MAX_VALUE >> 1; //BIT(31) mark as sysid
+    private static final String sCellName = SystemProperties.get("ro.boot.vm.name", "none");
+    private static int mSysId = -1;
 
     //***** Instance Variables
     @UnsupportedAppUsage
@@ -96,9 +100,20 @@ public class RILRequest {
             rr = new RILRequest();
         }
 
-        // Increment serial number. Wrap to 0 when reaching Integer.MAX_VALUE.
-        rr.mSerial = sNextSerial.getAndUpdate(n -> ((n + 1) % Integer.MAX_VALUE));
+        if (-1 == mSysId) {
+            if ("cell1".equals(sCellName)) {
+                mSysId = 0;
+            } else if ("cell2".equals(sCellName)) {
+                mSysId = 1;
+            } else {
+                Rlog.e(LOG_TAG, "CellName " + sCellName + " Error!");
+                throw new NullPointerException("sCellName is " + sCellName);
+            }
+        }
 
+        // Increment serial number. Wrap to 0 when reaching Integer.MAX_VALUE.
+        rr.mSerial = sNextSerial.getAndUpdate(n -> ((n + 1) % MAX_SERIAL_NUM));
+        rr.mSerial |= (mSysId << 31);
         rr.mRequest = request;
         rr.mResult = result;
 
diff --git a/frameworks/opt/telephony/src/java/com/android/internal/telephony/RadioIndication.java b/frameworks/opt/telephony/src/java/com/android/internal/telephony/RadioIndication.java
index d18efdcb9c..8770e0cb13 100644
--- a/frameworks/opt/telephony/src/java/com/android/internal/telephony/RadioIndication.java
+++ b/frameworks/opt/telephony/src/java/com/android/internal/telephony/RadioIndication.java
@@ -120,6 +120,7 @@ import com.android.internal.telephony.uicc.IccRefreshResponse;
 import com.android.internal.telephony.uicc.IccUtils;
 import com.android.internal.telephony.uicc.ReceivedPhonebookRecords;
 import com.android.internal.telephony.uicc.SimPhonebookRecord;
+import android.os.SystemProperties;
 
 import java.util.ArrayList;
 import java.util.List;
@@ -170,6 +171,10 @@ public class RadioIndication extends IRadioIndication.Stub {
     }
 
     public void newSms(int indicationType, ArrayList<Byte> pdu) {
+        if (!isActivateSys()) {
+            //后台系统不接收
+            return;
+        }
         mRil.processIndication(indicationType);
 
         byte[] pduArray = RIL.arrayListToPrimitiveArray(pdu);
@@ -183,6 +188,10 @@ public class RadioIndication extends IRadioIndication.Stub {
     }
 
     public void newSmsStatusReport(int indicationType, ArrayList<Byte> pdu) {
+        if (!isActivateSys()) {
+            //后台系统不接收
+            return;
+        }
         mRil.processIndication(indicationType);
 
         byte[] pduArray = RIL.arrayListToPrimitiveArray(pdu);
@@ -502,7 +511,20 @@ public class RadioIndication extends IRadioIndication.Stub {
         mRil.mIccRefreshRegistrants.notifyRegistrants(new AsyncResult (null, response, null));
     }
 
+    private boolean isActivateSys() {
+        String sys_stat = SystemProperties.get("persist.sys.exit", "1");
+        if ("0".equals(sys_stat)) {
+            return true;
+        }
+        return false;
+    }
+
     public void callRing(int indicationType, boolean isGsm, CdmaSignalInfoRecord record) {
+
+        if (!isActivateSys()) {
+            //后台系统不接收来电
+            return;
+        }
         mRil.processIndication(indicationType);
 
         char response[] = null;
@@ -534,6 +556,10 @@ public class RadioIndication extends IRadioIndication.Stub {
     }
 
     public void cdmaNewSms(int indicationType, CdmaSmsMessage msg) {
+        if (!isActivateSys()) {
+            //后台系统不接收
+            return;
+        }
         mRil.processIndication(indicationType);
 
         if (RIL.RILJ_LOGD) mRil.unsljLog(RIL_UNSOL_RESPONSE_CDMA_NEW_SMS);
-- 
2.17.1

