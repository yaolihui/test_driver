From ec8fa1ae0a1fcc8c238c041a2685d36170034516 Mon Sep 17 00:00:00 2001
From: jianglin <pppaass@163.com>
Date: Tue, 30 Aug 2022 02:14:23 +0800
Subject: [PATCH] virtual-system-v1.2

---
 core/rootdir/cells/system/hw/init.rc          |  4 +-
 core/rootdir/cells/system/wifi.rc             | 68 +++++++++----------
 ...d.hardware.input.classifier@1.0-service.rc | 18 ++---
 core/rootdir/cells/vendor/hw/init.oriole.rc   |  4 +-
 core/rootdir/init.rc                          | 11 ++-
 libhidl/transport/ServiceManagement.cpp       |  3 +-
 netd/server/RouteController.cpp               |  2 -
 7 files changed, 58 insertions(+), 52 deletions(-)

diff --git a/core/rootdir/cells/system/hw/init.rc b/core/rootdir/cells/system/hw/init.rc
index b5efe44..3bbdf37 100644
--- a/core/rootdir/cells/system/hw/init.rc
+++ b/core/rootdir/cells/system/hw/init.rc
@@ -67,7 +67,8 @@ on early-init
     start ueventd
 
     setprop ro.boot.vm 1
-    setprop persist.sys.exit 0
+    setprop persist.sys.exit 1
+    setprop persist.sys.cells.netagent ""
     setprop persist.logd.logpersistd logcatd
     # setprop system_init.startsensorservice 0
     setprop persist.sys.sdcardfs force_off
@@ -459,7 +460,6 @@ on init
     start servicemanager
     start hwservicemanager
     start vndservicemanager
-    start cellsservice
 
 # Healthd can trigger a full boot from charger mode by signaling this
 # property when the power button is held.
diff --git a/core/rootdir/cells/system/wifi.rc b/core/rootdir/cells/system/wifi.rc
index 71567ed..eceee0a 100644
--- a/core/rootdir/cells/system/wifi.rc
+++ b/core/rootdir/cells/system/wifi.rc
@@ -29,54 +29,54 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
    # Create trace buffer, and set basic configuration.
    mkdir /sys/kernel/debug/tracing/instances/wifi 711
    restorecon_recursive /sys/kernel/debug/tracing/instances/wifi
-#   write /sys/kernel/debug/tracing/instances/wifi/tracing_on 0
-#   write /sys/kernel/debug/tracing/instances/wifi/buffer_size_kb 1
-#   write /sys/kernel/debug/tracing/instances/wifi/trace_options disable_on_free
+   write /sys/kernel/debug/tracing/instances/wifi/tracing_on 0
+   write /sys/kernel/debug/tracing/instances/wifi/buffer_size_kb 1
+   write /sys/kernel/debug/tracing/instances/wifi/trace_options disable_on_free
 
    mkdir /sys/kernel/tracing/instances/wifi 711
    restorecon_recursive /sys/kernel/tracing/instances/wifi
-#   write /sys/kernel/tracing/instances/wifi/tracing_on 0
-#   write /sys/kernel/tracing/instances/wifi/buffer_size_kb 1
-#   write /sys/kernel/tracing/instances/wifi/trace_options disable_on_free
+   write /sys/kernel/tracing/instances/wifi/tracing_on 0
+   write /sys/kernel/tracing/instances/wifi/buffer_size_kb 1
+   write /sys/kernel/tracing/instances/wifi/trace_options disable_on_free
 
    # Enable cfg80211 events for connection and key management events.
    # - Events are not actually logged until WifiService writes "1" to
    #   /sys/kernel/debug/tracing/instances/wifi/tracing_on.
    # - WifiService is responsible for turning tracing off and on.
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_auth/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_connect/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_key/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_mgmt_key/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_rekey_data/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_auth/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_connect/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_key/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_mgmt_key/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_rekey_data/enable 1
 
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_auth/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_connect/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_default_key/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_default_mgmt_key/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_rekey_data/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_auth/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_connect/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_default_key/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_default_mgmt_key/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_set_rekey_data/enable 1
 
    # Enable datapath events for Wifi.
    # - Events are not actually logged until WifiService writes "1" to
    #   /sys/kernel/debug/tracing/instances/wifi/tracing_on.
    # - WifiService will ensure that tracing is turned back off,
    #   when a connection attempt ends (whether in success or failure)
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_queue/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_rx/enable 1
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_receive_skb/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_queue/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_rx/enable 1
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_receive_skb/enable 1
 
-#   write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
-#   write /sys/kernel/tracing/instances/wifi/events/net/net_dev_queue/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/net/netif_rx/enable 1
-#   write /sys/kernel/tracing/instances/wifi/events/net/netif_receive_skb/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
+   write /sys/kernel/tracing/instances/wifi/events/net/net_dev_queue/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/net/netif_rx/enable 1
+   write /sys/kernel/tracing/instances/wifi/events/net/netif_receive_skb/enable 1
 
    # Set DAC to allow system to enable/disable, and read wifi trace
    # events.
@@ -97,5 +97,5 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
 
 on property:sys.boot_completed=1 && property:wifi.interface=* && property:sys.wifitracing.started=1
    # Override default value.
-#   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface}
-#   write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface}
+   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface}
+   write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface}
diff --git a/core/rootdir/cells/vendor/android.hardware.input.classifier@1.0-service.rc b/core/rootdir/cells/vendor/android.hardware.input.classifier@1.0-service.rc
index 77a5fab..e6b70e5 100644
--- a/core/rootdir/cells/vendor/android.hardware.input.classifier@1.0-service.rc
+++ b/core/rootdir/cells/vendor/android.hardware.input.classifier@1.0-service.rc
@@ -1,9 +1,9 @@
-#service vendor.input.classifier-1-0 /vendor/bin/hw/android.hardware.input.classifier@1.0-service
-#    # Must be specified if "disabled" is set. This HAL will only start if requested via getService
-#    interface android.hardware.input.classifier@1.0::IInputClassifier default
-#    class hal
-#    user nobody
-#    # will not be restarted if it exits until it is requested to be restarted
-#    oneshot
-#    # will only be started when requested
-#    disabled
\ No newline at end of file
+service vendor.input.classifier-1-0 /vendor/bin/hw/android.hardware.input.classifier@1.0-service
+    # Must be specified if "disabled" is set. This HAL will only start if requested via getService
+    interface android.hardware.input.classifier@1.0::IInputClassifier default
+    class hal
+    user nobody
+    # will not be restarted if it exits until it is requested to be restarted
+    oneshot
+    # will only be started when requested
+    disabled
diff --git a/core/rootdir/cells/vendor/hw/init.oriole.rc b/core/rootdir/cells/vendor/hw/init.oriole.rc
index 4619220..d509c17 100644
--- a/core/rootdir/cells/vendor/hw/init.oriole.rc
+++ b/core/rootdir/cells/vendor/hw/init.oriole.rc
@@ -10,10 +10,10 @@ on init
 
 # Toggle glove_mode according to touch_sensitivity_mode
 on property:persist.vendor.touch_sensitivity_mode=0 && property:sys.boot_completed=1
-#   write /sys/class/spi_master/spi11/spi11.0/glove_mode 00
+    write /sys/class/spi_master/spi11/spi11.0/glove_mode 00
 
 on property:persist.vendor.touch_sensitivity_mode=1 && property:sys.boot_completed=1
-#   write /sys/class/spi_master/spi11/spi11.0/glove_mode 01
+    write /sys/class/spi_master/spi11/spi11.0/glove_mode 01
 
 on late-init && property:ro.boot.hardware.revision=PROTO1.0
     setprop vendor.thermal.config "thermal_info_config_WHI_A.json"
diff --git a/core/rootdir/init.rc b/core/rootdir/init.rc
index d28c730..60389b8 100644
--- a/core/rootdir/init.rc
+++ b/core/rootdir/init.rc
@@ -68,6 +68,8 @@ on early-init
 
     setprop ro.boot.vm 0
     setprop persist.sys.exit 0
+    setprop persist.sys.ui.exit 0
+    setprop persist.sys.iw.wlan ""
     setprop persist.logd.logpersistd logcatd
     setprop persist.sys.sdcardfs force_on
 
@@ -457,7 +459,6 @@ on init
     start servicemanager
     start hwservicemanager
     start vndservicemanager
-    start cellsservice
 
 # Healthd can trigger a full boot from charger mode by signaling this
 # property when the power button is held.
@@ -1287,3 +1288,11 @@ service cellsservice /system/bin/cellsservice
     user root
     group root
     seclabel  u:r:init:s0
+
+service cellsstart /system/bin/cellsstart
+    class main
+    disabled
+    oneshot
+    user root
+    group root
+    seclabel  u:r:init:s0
diff --git a/libhidl/transport/ServiceManagement.cpp b/libhidl/transport/ServiceManagement.cpp
index 916ffc3..f089ec1 100644
--- a/libhidl/transport/ServiceManagement.cpp
+++ b/libhidl/transport/ServiceManagement.cpp
@@ -85,11 +85,10 @@ static bool getinithidlservice(const char* descriptor)
         "android.hardware.keymaster",
         "android.hardware.biometrics.fingerprint",
         "android.hardware.thermal",
-        "android.hardware.input.classifier",
         "android.hardware.audio",
         "android.hardware.soundtrigger",
         "android.hardware.secure_element",
-        "android.frameworks.sensorservice",
+        "android.hardware.radio",
         "vendor.samsung_slsi.telephony.hardware.radioExternal",
         NULL
     };
diff --git a/netd/server/RouteController.cpp b/netd/server/RouteController.cpp
index e34953b..7b794f0 100644
--- a/netd/server/RouteController.cpp
+++ b/netd/server/RouteController.cpp
@@ -1149,8 +1149,6 @@ int RouteController::flushRoutes(const char* interface) {
 }
 
 int RouteController::Init(unsigned localNetId) {
-    if(android::base::GetProperty("ro.boot.vm", "0") == std::string("1"))
-        return 0;
     if (int ret = flushRules()) {
         return ret;
     }
-- 
2.31.1

